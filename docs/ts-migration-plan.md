# План миграции CoffeeScript -> TypeScript (20/80)

Цель: переписать проект на TypeScript, не потеряв функционал. Подход — сначала минимально защититься тестами (20/80), затем мигрировать поэтапно с обязательными прогонами проверок.

## Принцип 20/80
- Тестируем не всё подряд, а критические пользовательские сценарии и самые рискованные алгоритмы.
- Критические области: генерация PAC, профили, sync/merge, storage, импорт/экспорт.
- Прогоны тестов обязательны на каждом шаге миграции.

## Этап 1. Аудит и карта рисков
- Список модулей и входов: `omega-pac`, `omega-target`, `omega-web`, `omega-target-chromium-extension`.
- Выделить 5–10 критичных сценариев, например:
  - генерация PAC из профилей;
  - работа условий/правил (conditions/shexp);
  - merge/sync опций;
  - экспорт/импорт профилей;
  - базовые операции UI (если возможно — смоуки).
- Проверить, какие тесты уже есть, и где покрытие слабое.

## Этап 2. Тестовый «пояс безопасности» (20/80)
- Усилить тесты в `omega-pac` и `omega-target` (ядро логики).
- Добавлять точечные тесты по принципу «один тест — один инвариант».
- Минимум моков, максимум вход/выход.
- Если UI-тесты тяжёлые — заменить смоуками на API/сервисах.

## Этап 3. Техническая база TypeScript (без миграции логики)
- Добавить `tsconfig` и сборку TypeScript параллельно с CoffeeScript.
- Настроить совместимость CommonJS/Browserify/Grunt, чтобы формат выходных артефактов совпадал с текущим.
- На этом этапе не переписывать логику — только инфраструктура.

## Этап 4. Пошаговая миграция модулей
Рекомендуемый порядок:
1) `omega-pac` (меньше внешних зависимостей, чистая логика)
2) `omega-target` (ядро логики + sync/storage)
3) `omega-web` (можно отложить)
4) `omega-target-chromium-extension` (последним)

Практика миграции:
- Переводить по файлам или небольшими партиями (5–10 файлов).
- После каждой партии — прогон тестов/смоуков.
- Регрессии фиксировать сразу, не накапливать.

## Этап 5. Завершение
- Отключить CoffeeScript сборку (или оставить в legacy-режиме, если нужно).
- Финальный полный прогон тестов.
- Обновить `README.md` и документацию на новый пайплайн.

## Контрольные проверки (после каждого значимого шага)
- `cd omega-pac && npm test`
- `cd omega-target && npm test`
