# План работ: актуализация документации и правил агентов

Цель: привести документацию/правила для агентов к состоянию, которое **точно соответствует текущей кодовой базе и воспроизводимой среде**, и зафиксировать “контракты/ловушки” в коде через `AICODE-*` якоря.

Контекст (текущее состояние):

- `README.md` исторически описывает проект и сборку, но не был “картой репозитория” для агентов.
- В репозитории почти не было `AICODE-*` якорей (кроме `docs/aicode.md`/`AGENTS.md`); навигационные точки входа добавлены только недавно.
- Обязательные тесты из `AGENTS.md` зелёные на Node 20.x.
- Требования по Node синхронизированы с репозиторием через `.nvmrc` и README.
- AICODE-якоря добавлены в ключевых местах (входы + контракты/ловушки).

---

## 0) Принципы выполнения (строго по `AGENTS.md`)

Перед изменениями:

- Всегда запускать поиск: `rg -n "AICODE-"` и избегать дублей якорей.
- Использовать `README.md` как индекс-карту (пути + “как найти через rg/AICODE”).

После любых изменений в репозитории:

- Обязательно прогонять тесты:
  - `cd omega-pac && npm test`
  - `cd omega-target && npm test`

---

## 1) Рабочие потоки (workstreams)

Ниже — список работ, которые логически отделяются и могут выполняться последовательно (с минимальными параллельными ветками).

### A. Документация-навигация (README как индекс)

Цель: сделать `README.md` **устойчивой** картой, которая выдерживает рефакторинг (минимум привязок к “строкам”, максимум — к путям и `rg`).

Задачи:

1. Проверить, что в `README.md` есть обязательные секции по протоколу:
   - Repository layout (10–25 пунктов)
   - Entry points (3–10 пунктов)
   - Common tasks (только существующие команды)
   - Search cookbook (8–15 реальных `rg -n ...`)
2. Для каждого пункта:
   - путь/файл;
   - 1 строка “для чего”;
   - “как найти” (`AICODE-*` или конкретный `rg -n ...`).
3. Минимизировать “эссе” и маркетинговый текст — индекс должен быть быстрым.

Критерии готовности:

- Новичок/агент способен за 2–5 минут найти:
  - где `omega-pac` генерит PAC,
  - где `omega-target` хранит и мержит опции,
  - где “target” для расширения,
  - какие команды запускать.

---

### B. AICODE-якоря: навигация + “контракты/ловушки” рядом с кодом

Цель: чтобы `rg -n "AICODE-"` давал **полезные** ответы: что нельзя ломать, где точка входа, где тестировать.

Задачи:

1. Навигационные якоря (`AICODE-NOTE: NAV/...`) в ключевых “входах”:
   - публичные экспорты/точки интеграции;
   - места, где один модуль реэкспортирует другой.
2. Якоря “контракт/ловушка” (`AICODE-CONTRACT` / `AICODE-TRAP`, с датой) вокруг областей с тестовыми падениями:
   - `omega-pac`:
     - контракт формата `SOCKS5`/fallback на `SOCKS` в `pacResult`;
     - указать риск (совместимость PAC в браузерах).
   - `omega-target`:
     - контракт `OptionsSync#merge` при `syncOptions: "disabled"`;
     - ловушка таймеров/дедупликации `requestPush` (таймауты в тестах).
3. Для каждого контракта/ловушки добавить:
   - `ref:` на тест, который фиксирует поведение;
   - `risk:` что ломается;
   - `test:` команду/файл теста.

Критерии готовности:

- `rg -n "AICODE-" omega-pac omega-target` выводит 5–15 строк, из которых понятно:
  - что является “входом”,
  - какие инварианты защищать,
  - куда смотреть для диагностики.

<!-- AICODE-TODO: fix omega-pac package.json "main" to stop Node DEP0128 warning in omega-target tests; why: Node 20 prints invalid main field warning; scope: omega-pac/package.json; test: cd omega-target && npm test -->

---

### C. Окружение: согласование требований Node/npm с реальностью

Цель: чтобы требования к среде были **однозначными** и воспроизводимыми, а локальная разработка не “плавала”.

Задачи:

1. Выбрать “истину” по версии Node:
   - Вариант 1 (предпочтительный): зафиксировать Node 20.x как в README.
   - Вариант 2: обновить README, если проект реально перешёл на Node 22.
2. Зафиксировать выбранный вариант в репозитории:
   - добавить `.nvmrc` (или иной механизм, если в проекте принят другой стандарт);
   - обновить `README.md` (и при необходимости `omega-build/` инструкции).
3. После фиксации версии:
   - прогнать `npm test` в `omega-pac` и `omega-target`;
   - если падения исчезли/поменялись — зафиксировать в AICODE-TRAP (узкое место совместимости Node).

Критерии готовности:

- С нуля можно воспроизвести окружение, не угадывая версию Node.
- Пояснено, какая версия Node считается поддерживаемой и почему.

---

### D. Стабилизация тестов (сделать обязательные тесты “зелёными”)

Цель: привести `AGENTS.md` правило “всегда запускать тесты” в рабочее состояние: тесты должны быть зелёными в поддерживаемом окружении.

#### D1. `omega-pac`: падение `Profiles #pacResult` (SOCKS5)

Гипотеза: изменилось ожидаемое поведение формирования результата для SOCKS5 (или окружение/зависимости), поэтому тест не совпадает с фактом.

Шаги:

1. Открыть тест:
   - `omega-pac/test/profiles.coffee` (тест, который падает).
2. Найти код, который формирует `pacResult`:
   - вероятно `omega-pac/src/profiles.coffee` (или рядом).
3. Определить “истину”:
   - что должно возвращаться для SOCKS5: только `SOCKS5 ...` или `SOCKS5 ...; SOCKS ...`.
   - проверить требования WebProxy/PAC совместимости (Chromium/Firefox).
4. Привести к консистентности:
   - либо исправить код, либо обновить тест (если контракт поменялся осознанно).
5. Добавить `AICODE-CONTRACT` (с датой) около места формирования результата.

Acceptance criteria:

- `cd omega-pac && npm test` зелёный.

#### D2. `omega-target`: `OptionsSync` merge + таймауты requestPush

Гипотеза: тесты завязаны на поведение таймеров/очередей (Node/lolex/sinon) либо на изменение логики `syncOptions: "disabled"`.

Шаги:

1. Открыть тесты:
   - `omega-target/test/options_sync.coffee`.
2. Сопоставить с реализацией:
   - `omega-target/src/options_sync.coffee`.
3. Разобрать контракт `#merge`:
   - что означает `syncOptions: "disabled"` в oldVal/newVal;
   - какой приоритет должен быть у “локального” значения.
4. Разобрать таймауты `#requestPush`:
   - как планируется отложенная запись;
   - как объединяются множественные запросы;
   - где/как используются таймеры (возможный конфликт с Node 22).
5. Починить один из вариантов:
   - (а) логика в коде;
   - (б) изоляция таймеров в тестах (правильная установка fake timers);
   - (в) увеличить таймауты как крайняя мера (если это реально долгий I/O — но предпочтительно избегать).
6. Добавить `AICODE-CONTRACT` / `AICODE-TRAP` рядом с соответствующей логикой.

Acceptance criteria:

- `cd omega-target && npm test` зелёный.

---

## Статус выполнения (без CI)

- A: выполнено (README уже соответствует протоколу и обновлён в части Node).
- B: выполнено (AICODE-CONTRACT/TRAP добавлены рядом с критичной логикой).
- C: выполнено (Node 20.x зафиксирован через `.nvmrc`, README обновлён).
- D: выполнено (тесты зелёные на Node 20.x).
- Осталось: `AICODE-TODO` в этом файле про предупреждение `Invalid 'main' field` в `omega-pac`.

## 2) Предлагаемый порядок выполнения (итерации)

Итерация 1 (быстрое выравнивание):

1. C: зафиксировать поддерживаемую версию Node и привести README/репо к ней.
2. D: привести тесты `omega-pac` и `omega-target` к зелёному состоянию в этой версии Node.

Итерация 2 (формализация знаний в коде):

3. B: добавить AICODE-CONTRACT/TRAP для “болезненных” мест, которые всплыли при фиксе тестов.

Итерация 3 (поддержка и масштабирование):

4. A: при необходимости расширить README-индекс (если после фиксов поменялись точки входа/команды).

---

## 3) Команды проверки (как “definition of done”)

- Якоря: `rg -n "AICODE-"`.
- Тесты:
  - `cd omega-pac && npm test`
  - `cd omega-target && npm test`
- (опционально) сборка:
  - `cd omega-build && npm run build`
